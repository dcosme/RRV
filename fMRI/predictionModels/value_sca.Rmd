---
title: "Value SCAs"
author: "Dani Cosme"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    df_print: paged
    highlight: tango
    theme: united
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# load packages
```{r}
library(tidyverse)
library(MuMIn)
library(purrr)
library(broom)
```

# load and tidy data
Read `full_dataset.RDS` save from the `prediction_models.Rmd`

```{r}
dataset = readRDS("full_dataset.RDS")
```

```{r}
model_data_snack = dataset %>%
  filter(((!grepl("neuralsig", map) & mask == "masked") | (grepl("neuralsig", map) & mask == "unmasked")) & 
           session == "all" & control == "nature" & condition == "snack") %>% #& test == "association" 
  unique() %>%
  group_by(process, subjectID) %>%
  mutate(meanProcessPEstd = mean(meanPE_std, na.rm = TRUE),
         processPE = paste0(process, "_PE")) %>%
  select(-c(xyz, meanPE, meanPE_std, sdPE, dotProduct, map)) %>%
  unite(process, process, test, sep = "_") %>%
  spread(process, dotProduct_std) %>%
  spread(processPE, meanProcessPEstd) %>%
  group_by(subjectID) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  select(-c(roi, craving_PE, craving_regulation_PE, age, gender, mask)) %>%
  unique() %>%
  mutate(balancePE = cognitive_control_PE - reward_PE) %>%
  gather(var, val, contains("association"), contains("uniformity")) %>%
  mutate(var = sprintf("%s_PEV", var)) %>%
  spread(var, val)
```

# set SCA model options
```{r}
# set na.action for dredge
options(na.action = "na.fail")

# specify number of cores to parallelization
n_cores = 7
```

# BMI-value SCA
## association
```{r}
data = model_data_snack %>%
  select_if(grepl("subjectID|bmi|reward|value|cognitive|craving|balance", names(.))) %>%
  select(-contains("uniformity")) %>%
  ungroup() %>%
  na.omit()
lm_predictors = paste(names(select(data, -c(subjectID, bmi))), collapse = " + ")
lm_formula = formula(paste0("bmi ~ ", lm_predictors, collapse = " + "))

full_model = lm(lm_formula,
                data = data)

clust = parallel::makeCluster(getOption("cl.cores", n_cores))
invisible(parallel::clusterCall(clust, "library", character.only = TRUE))
parallel::clusterExport(clust, "data")

bmi_value_sca = MuMIn::dredge(full_model, rank = "AIC", extra = "BIC")
parallel::stopCluster(clust)

```

### extract parameter estimates, 95% CIs, and p-values
```{r}
# extract parameter estimate
model_params = MuMIn::get.models(bmi_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest() %>%
  select(model_num, term, estimate) %>%
  spread(term, estimate)

# calculate 95% CIs
model_conf = MuMIn::get.models(bmi_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::confint_tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest()

# extract p-values for the intercept term
model_ps_PEV = MuMIn::get.models(bmi_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest() %>%
  bind_cols(., model_conf) %>%
  filter(term == "value_association_PEV") %>%
  ungroup() %>%
  select(model_num, estimate, std.error, p.value, conf.low, conf.high) %>%
  arrange(p.value)

# extract p-values for the intercept term
model_ps_PE = MuMIn::get.models(bmi_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest() %>%
  bind_cols(., model_conf) %>%
  filter(term == "value_PE") %>%
  ungroup() %>%
  select(model_num, estimate, std.error, p.value, conf.low, conf.high) %>%
  arrange(p.value)
```

### value ROI SCA
Value-BMI associations p < .05 are in red, p > .05 are in black

```{r, fig.width=10, fig.height=10}
null = bmi_value_sca %>%
  arrange(df) %>%
  filter(df == 3 & !is.na(value_PE))

# merge and tidy for plotting
plot.data = left_join(model_ps_PE, model_params, by = c("model_num")) %>%
  select(-c(`(Intercept)`, value_PE)) %>%
  arrange(estimate) %>%
  mutate(specification = row_number(),
         significant.p = ifelse(p.value < .05, "yes", "no")) %>%
  gather(variable, val, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p,  -contains("conf")) %>% 
  mutate(`univariate ROI` = ifelse(grepl("PE", variable) & !is.na(val), 1, NA),
         `multivariate PEV` = ifelse(grepl("PEV", variable) & !is.na(val), 1, NA),
         `cognitive control` = ifelse(grepl("cognitive_control", variable) & !is.na(val), 1, NA),
         reward = ifelse(grepl("reward", variable) & !is.na(val), 1, NA),
         `value ROI only` = ifelse(estimate == null$value_PE, 1, NA),
         variable = gsub("_", " ", variable),
         variable = gsub("PE$", " ROI", variable),
         variable = gsub("PEV", " PEV", variable),
         variable = gsub("regulation association", "regulation", variable)) %>%
  spread(variable, val) %>%
  unique()

# get names of variables included in model
variable.names = names(select(plot.data, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p, -contains("conf")))

# plot top panel
top = plot.data %>%
  ggplot(aes(specification, estimate, color = significant.p)) +
    #geom_point(shape = "|", size = 4) +
    geom_pointrange(aes(ymin = conf.low, ymax = conf.high), size = .25) +
    scale_color_manual(values = c("red")) + #"black", 
    #scale_y_continuous(limits = c(-1, 7), breaks = seq(-1, 7, by = 1)) +
    labs(x = "", y = "\nassociation between BMI &\nunivariate ROI") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# set plotting order for variables based on number of times it's included in better fitting models
order = plot.data %>%
  arrange(estimate) %>%
  mutate(significant.p.num = ifelse(significant.p == "yes", 1, 0)) %>%
  gather(variable, val, eval(variable.names)) %>% 
  filter(!is.na(val)) %>%
  group_by(variable) %>%
  mutate(order = sum(significant.p.num)) %>%
  select(variable, order) %>%
  unique()

# rename variables and plot bottom panel
bottom = plot.data %>%
  gather(variable, value, eval(variable.names)) %>% 
  mutate(value = ifelse(!is.na(value), "|", ""),
         variable = ifelse(variable == "(Intercept)", "intercept", variable)) %>%
  left_join(., order, by = "variable") %>%
  ggplot(aes(specification, reorder(variable, order), color = significant.p)) +
    geom_text(aes(label = value)) +
    scale_color_manual(values = c("red")) + #"black"
    labs(x = "\nspecification number", y = "variables") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# join panels
(coef_plot = cowplot::plot_grid(top, bottom, ncol = 1, align = "v", rel_heights = c(.4, .6), labels = c('A', 'B')))
```

### value PEV SCA
```{r, fig.width=10, fig.height=10}
null = bmi_value_sca %>%
  arrange(df) %>%
  filter(df == 3 & !is.na(value_association_PEV))

# merge and tidy for plotting
plot.data = left_join(model_ps_PEV, model_params, by = c("model_num")) %>%
  select(-c(`(Intercept)`, value_association_PEV)) %>%
  arrange(estimate) %>%
  mutate(specification = row_number(),
         significant.p = ifelse(p.value < .05, "yes", "no")) %>%
  gather(variable, val, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p,  -contains("conf")) %>% 
  mutate(`univariate ROI` = ifelse(grepl("PE", variable) & !is.na(val), 1, NA),
         `multivariate PEV` = ifelse(grepl("PEV", variable) & !is.na(val), 1, NA),
         `cognitive control` = ifelse(grepl("cognitive_control", variable) & !is.na(val), 1, NA),
         reward = ifelse(grepl("reward", variable) & !is.na(val), 1, NA),
         `value PEV only`= ifelse(estimate == null$value_association_PEV, 1, NA),
         #craving = ifelse(grepl("craving_", variable) & !is.na(val), 1, NA),
         `craving regulation` = ifelse(grepl("craving_regulation", variable) & !is.na(val), 1, NA),
         variable = gsub("_", " ", variable),
         variable = gsub("PE$", " ROI", variable),
         variable = gsub("PEV", " PEV", variable),
         variable = gsub("regulation association", "regulation", variable)) %>%
  spread(variable, val) %>%
  unique()

# get names of variables included in model
variable.names = names(select(plot.data, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p, -contains("conf")))

# plot top panel
top = plot.data %>%
  ggplot(aes(specification, estimate, color = significant.p)) +
    #geom_point(shape = "|", size = 4) +
    geom_pointrange(aes(ymin = conf.low, ymax = conf.high), size = .25) +
    scale_color_manual(values = c("black", "red")) +
    #scale_y_continuous(limits = c(-1, 7), breaks = seq(-1, 7, by = 1)) +
    labs(x = "", y = "\nassociation between BMI &\nmultivariate value PEV") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# set plotting order for variables based on number of times it's included in better fitting models
order = plot.data %>%
  arrange(estimate) %>%
  mutate(significant.p.num = ifelse(significant.p == "yes", 1, 0)) %>%
  gather(variable, val, eval(variable.names)) %>% 
  filter(!is.na(val)) %>%
  group_by(variable) %>%
  mutate(order = sum(significant.p.num)) %>%
  select(variable, order) %>%
  unique()

# rename variables and plot bottom panel
bottom = plot.data %>%
  gather(variable, value, eval(variable.names)) %>% 
  mutate(value = ifelse(!is.na(value), "|", ""),
         variable = ifelse(variable == "(Intercept)", "intercept", variable)) %>%
  left_join(., order, by = "variable") %>%
  ggplot(aes(specification, reorder(variable, order), color = significant.p)) +
    geom_text(aes(label = value)) +
    scale_color_manual(values = c("black", "red")) +
    labs(x = "\nspecification number", y = "variables") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# join panels
(coef_plot = cowplot::plot_grid(top, bottom, ncol = 1, align = "v", rel_heights = c(.4, .6), labels = c('A', 'B')))
```




## uniformity
```{r}
data = model_data_snack %>%
  select_if(grepl("subjectID|bmi|reward|value|cognitive|craving|balance", names(.))) %>%
  select(-c(cognitive_control_association_PEV, craving_association_PEV, reward_association_PEV, value_association_PEV)) %>%
  ungroup() %>%
  na.omit()
lm_predictors = paste(names(select(data, -c(subjectID, bmi))), collapse = " + ")
lm_formula = formula(paste0("bmi ~ ", lm_predictors, collapse = " + "))

full_model = lm(lm_formula,
                data = data)

clust = parallel::makeCluster(getOption("cl.cores", n_cores))
invisible(parallel::clusterCall(clust, "library", character.only = TRUE))
parallel::clusterExport(clust, "data")

bmi_value_sca = MuMIn::dredge(full_model, rank = "AIC", extra = "BIC")
parallel::stopCluster(clust)

```

### extract parameter estimates, 95% CIs, and p-values
```{r}
# extract parameter estimate
model_params = MuMIn::get.models(bmi_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest() %>%
  select(model_num, term, estimate) %>%
  spread(term, estimate)

# calculate 95% CIs
model_conf = MuMIn::get.models(bmi_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::confint_tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest()

# extract p-values for the intercept term
model_ps_PEV = MuMIn::get.models(bmi_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest() %>%
  bind_cols(., model_conf) %>%
  filter(term == "value_uniformity_PEV") %>%
  ungroup() %>%
  select(model_num, estimate, std.error, p.value, conf.low, conf.high) %>%
  arrange(p.value)

# extract p-values for the intercept term
model_ps_PE = MuMIn::get.models(bmi_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest() %>%
  bind_cols(., model_conf) %>%
  filter(term == "value_PE") %>%
  ungroup() %>%
  select(model_num, estimate, std.error, p.value, conf.low, conf.high) %>%
  arrange(p.value)
```

### value ROI SCA
Value-BMI associations p < .05 are in red, p > .05 are in black

```{r, fig.width=10, fig.height=10}
null = bmi_value_sca %>%
  arrange(df) %>%
  filter(df == 3 & !is.na(value_PE))

# merge and tidy for plotting
plot.data = left_join(model_ps_PE, model_params, by = c("model_num")) %>%
  select(-c(`(Intercept)`, value_PE)) %>%
  arrange(estimate) %>%
  mutate(specification = row_number(),
         significant.p = ifelse(p.value < .05, "yes", "no")) %>%
  gather(variable, val, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p,  -contains("conf")) %>% 
  mutate(`univariate ROI` = ifelse(grepl("PE", variable) & !is.na(val), 1, NA),
         `multivariate PEV` = ifelse(grepl("PEV", variable) & !is.na(val), 1, NA),
         `cognitive control` = ifelse(grepl("cognitive_control", variable) & !is.na(val), 1, NA),
         reward = ifelse(grepl("reward", variable) & !is.na(val), 1, NA),
         `value ROI only` = ifelse(estimate == null$value_PE, 1, NA),
         variable = gsub("_", " ", variable),
         variable = gsub("PE$", " ROI", variable),
         variable = gsub("PEV", " PEV", variable),
         variable = gsub("regulation association", "regulation", variable)) %>%
  spread(variable, val) %>%
  unique()

# get names of variables included in model
variable.names = names(select(plot.data, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p, -contains("conf")))

# plot top panel
top = plot.data %>%
  ggplot(aes(specification, estimate, color = significant.p)) +
    #geom_point(shape = "|", size = 4) +
    geom_pointrange(aes(ymin = conf.low, ymax = conf.high), size = .25) +
    scale_color_manual(values = c("red")) + #"black", 
    #scale_y_continuous(limits = c(-1, 7), breaks = seq(-1, 7, by = 1)) +
    labs(x = "", y = "\nassociation between BMI &\nunivariate ROI") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# set plotting order for variables based on number of times it's included in better fitting models
order = plot.data %>%
  arrange(estimate) %>%
  mutate(significant.p.num = ifelse(significant.p == "yes", 1, 0)) %>%
  gather(variable, val, eval(variable.names)) %>% 
  filter(!is.na(val)) %>%
  group_by(variable) %>%
  mutate(order = sum(significant.p.num)) %>%
  select(variable, order) %>%
  unique()

# rename variables and plot bottom panel
bottom = plot.data %>%
  gather(variable, value, eval(variable.names)) %>% 
  mutate(value = ifelse(!is.na(value), "|", ""),
         variable = ifelse(variable == "(Intercept)", "intercept", variable)) %>%
  left_join(., order, by = "variable") %>%
  ggplot(aes(specification, reorder(variable, order), color = significant.p)) +
    geom_text(aes(label = value)) +
    scale_color_manual(values = c("red")) + #"black"
    labs(x = "\nspecification number", y = "variables") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# join panels
(coef_plot = cowplot::plot_grid(top, bottom, ncol = 1, align = "v", rel_heights = c(.4, .6), labels = c('A', 'B')))
```

### value PEV SCA
```{r, fig.width=10, fig.height=10}
null = bmi_value_sca %>%
  arrange(df) %>%
  filter(df == 3 & !is.na(value_uniformity_PEV))

# merge and tidy for plotting
plot.data = left_join(model_ps_PEV, model_params, by = c("model_num")) %>%
  select(-c(`(Intercept)`, value_uniformity_PEV)) %>%
  arrange(estimate) %>%
  mutate(specification = row_number(),
         significant.p = ifelse(p.value < .05, "yes", "no")) %>%
  gather(variable, val, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p,  -contains("conf")) %>% 
  mutate(`univariate ROI` = ifelse(grepl("PE", variable) & !is.na(val), 1, NA),
         `multivariate PEV` = ifelse(grepl("PEV", variable) & !is.na(val), 1, NA),
         `cognitive control` = ifelse(grepl("cognitive_control", variable) & !is.na(val), 1, NA),
         reward = ifelse(grepl("reward", variable) & !is.na(val), 1, NA),
         `value PEV only` = ifelse(estimate == null$value_uniformity_PEV, 1, NA),
         variable = gsub("_", " ", variable),
         variable = gsub("PE$", " ROI", variable),
         variable = gsub("PEV", " PEV", variable),
         variable = gsub("regulation association", "regulation", variable)) %>%
  spread(variable, val) %>%
  unique()

# get names of variables included in model
variable.names = names(select(plot.data, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p, -contains("conf")))

# plot top panel
top = plot.data %>%
  ggplot(aes(specification, estimate, color = significant.p)) +
    #geom_point(shape = "|", size = 4) +
    geom_pointrange(aes(ymin = conf.low, ymax = conf.high), size = .25) +
    scale_color_manual(values = c("black", "red")) +
    #scale_y_continuous(limits = c(-1, 7), breaks = seq(-1, 7, by = 1)) +
    labs(x = "", y = "\nassociation between BMI &\nmultivariate value PEV") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# set plotting order for variables based on number of times it's included in better fitting models
order = plot.data %>%
  arrange(estimate) %>%
  mutate(significant.p.num = ifelse(significant.p == "yes", 1, 0)) %>%
  gather(variable, val, eval(variable.names)) %>% 
  filter(!is.na(val)) %>%
  group_by(variable) %>%
  mutate(order = sum(significant.p.num)) %>%
  select(variable, order) %>%
  unique()

# rename variables and plot bottom panel
bottom = plot.data %>%
  gather(variable, value, eval(variable.names)) %>% 
  mutate(value = ifelse(!is.na(value), "|", ""),
         variable = ifelse(variable == "(Intercept)", "intercept", variable)) %>%
  left_join(., order, by = "variable") %>%
  ggplot(aes(specification, reorder(variable, order), color = significant.p)) +
    geom_text(aes(label = value)) +
    scale_color_manual(values = c("black", "red")) +
    labs(x = "\nspecification number", y = "variables") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# join panels
(coef_plot = cowplot::plot_grid(top, bottom, ncol = 1, align = "v", rel_heights = c(.4, .6), labels = c('A', 'B')))
```

# % fat-value SCA
## association
```{r}
data = model_data_snack %>%
  select_if(grepl("subjectID|fat|reward|value|cognitive|craving|balance", names(.))) %>%
  select(-contains("uniformity")) %>%
  ungroup() %>%
  na.omit()
lm_predictors = paste(names(select(data, -c(subjectID, fat))), collapse = " + ")
lm_formula = formula(paste0("fat ~ ", lm_predictors, collapse = " + "))

full_model = lm(lm_formula,
                data = data)

clust = parallel::makeCluster(getOption("cl.cores", n_cores))
invisible(parallel::clusterCall(clust, "library", character.only = TRUE))
parallel::clusterExport(clust, "data")

fat_value_sca = MuMIn::dredge(full_model, rank = "AIC", extra = "BIC")
parallel::stopCluster(clust)

```

### extract parameter estimates, 95% CIs, and p-values
```{r}
# extract parameter estimate
model_params = MuMIn::get.models(fat_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest() %>%
  select(model_num, term, estimate) %>%
  spread(term, estimate)

# calculate 95% CIs
model_conf = MuMIn::get.models(fat_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::confint_tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest()

# extract p-values for the intercept term
model_ps_PEV = MuMIn::get.models(fat_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest() %>%
  bind_cols(., model_conf) %>%
  filter(term == "value_association_PEV") %>%
  ungroup() %>%
  select(model_num, estimate, std.error, p.value, conf.low, conf.high) %>%
  arrange(p.value)

# extract p-values for the intercept term
model_ps_PE = MuMIn::get.models(fat_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest() %>%
  bind_cols(., model_conf) %>%
  filter(term == "value_PE") %>%
  ungroup() %>%
  select(model_num, estimate, std.error, p.value, conf.low, conf.high) %>%
  arrange(p.value)
```

### value ROI SCA
Value-%fat associations p < .05 are in red, p > .05 are in black

```{r, fig.width=10, fig.height=10}
null = fat_value_sca %>%
  arrange(df) %>%
  filter(df == 3 & !is.na(value_PE))

# merge and tidy for plotting
plot.data = left_join(model_ps_PE, model_params, by = c("model_num")) %>%
  select(-c(`(Intercept)`, value_PE)) %>%
  arrange(estimate) %>%
  mutate(specification = row_number(),
         significant.p = ifelse(p.value < .05, "yes", "no")) %>%
  gather(variable, val, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p,  -contains("conf")) %>% 
  mutate(`univariate ROI` = ifelse(grepl("PE", variable) & !is.na(val), 1, NA),
         `multivariate PEV` = ifelse(grepl("PEV", variable) & !is.na(val), 1, NA),
         `cognitive control` = ifelse(grepl("cognitive_control", variable) & !is.na(val), 1, NA),
         reward = ifelse(grepl("reward", variable) & !is.na(val), 1, NA),
         `value ROI only` = ifelse(estimate == null$value_PE, 1, NA),
         variable = gsub("_", " ", variable),
         variable = gsub("PE$", " ROI", variable),
         variable = gsub("PEV", " PEV", variable),
         variable = gsub("regulation association", "regulation", variable)) %>%
  spread(variable, val) %>%
  unique()

# get names of variables included in model
variable.names = names(select(plot.data, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p, -contains("conf")))

# plot top panel
top = plot.data %>%
  ggplot(aes(specification, estimate, color = significant.p)) +
    #geom_point(shape = "|", size = 4) +
    geom_pointrange(aes(ymin = conf.low, ymax = conf.high), size = .25) +
    scale_color_manual(values = c("black", "red")) + #"black", 
    #scale_y_continuous(limits = c(-1, 7), breaks = seq(-1, 7, by = 1)) +
    labs(x = "", y = "\nassociation between % fat &\nunivariate ROI") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# set plotting order for variables based on number of times it's included in better fitting models
order = plot.data %>%
  arrange(estimate) %>%
  mutate(significant.p.num = ifelse(significant.p == "yes", 1, 0)) %>%
  gather(variable, val, eval(variable.names)) %>% 
  filter(!is.na(val)) %>%
  group_by(variable) %>%
  mutate(order = sum(significant.p.num)) %>%
  select(variable, order) %>%
  unique()

# rename variables and plot bottom panel
bottom = plot.data %>%
  gather(variable, value, eval(variable.names)) %>% 
  mutate(value = ifelse(!is.na(value), "|", ""),
         variable = ifelse(variable == "(Intercept)", "intercept", variable)) %>%
  left_join(., order, by = "variable") %>%
  ggplot(aes(specification, reorder(variable, order), color = significant.p)) +
    geom_text(aes(label = value)) +
    scale_color_manual(values = c("black", "red")) + #"black"
    labs(x = "\nspecification number", y = "variables") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# join panels
(coef_plot = cowplot::plot_grid(top, bottom, ncol = 1, align = "v", rel_heights = c(.4, .6), labels = c('A', 'B')))
```

### value PEV SCA
```{r, fig.width=10, fig.height=10}
null = fat_value_sca %>%
  arrange(df) %>%
  filter(df == 3 & !is.na(value_association_PEV))

# merge and tidy for plotting
plot.data = left_join(model_ps_PEV, model_params, by = c("model_num")) %>%
  select(-c(`(Intercept)`, value_association_PEV)) %>%
  arrange(estimate) %>%
  mutate(specification = row_number(),
         significant.p = ifelse(p.value < .05, "yes", "no")) %>%
  gather(variable, val, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p,  -contains("conf")) %>% 
  mutate(`univariate ROI` = ifelse(grepl("PE", variable) & !is.na(val), 1, NA),
         `multivariate PEV` = ifelse(grepl("PEV", variable) & !is.na(val), 1, NA),
         `cognitive control` = ifelse(grepl("cognitive_control", variable) & !is.na(val), 1, NA),
         reward = ifelse(grepl("reward", variable) & !is.na(val), 1, NA),
         `value PEV only` = ifelse(estimate == null$value_association_PEV, 1, NA),
         variable = gsub("_", " ", variable),
         variable = gsub("PE$", " ROI", variable),
         variable = gsub("PEV", " PEV", variable),
         variable = gsub("regulation association", "regulation", variable)) %>%
  spread(variable, val) %>%
  unique()

# get names of variables included in model
variable.names = names(select(plot.data, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p, -contains("conf")))

# plot top panel
top = plot.data %>%
  ggplot(aes(specification, estimate, color = significant.p)) +
    #geom_point(shape = "|", size = 4) +
    geom_pointrange(aes(ymin = conf.low, ymax = conf.high), size = .25) +
    scale_color_manual(values = c("black", "red")) +
    #scale_y_continuous(limits = c(-1, 7), breaks = seq(-1, 7, by = 1)) +
    labs(x = "", y = "\nassociation between % fat &\nmultivariate value PEV") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# set plotting order for variables based on number of times it's included in better fitting models
order = plot.data %>%
  arrange(estimate) %>%
  mutate(significant.p.num = ifelse(significant.p == "yes", 1, 0)) %>%
  gather(variable, val, eval(variable.names)) %>% 
  filter(!is.na(val)) %>%
  group_by(variable) %>%
  mutate(order = sum(significant.p.num)) %>%
  select(variable, order) %>%
  unique()

# rename variables and plot bottom panel
bottom = plot.data %>%
  gather(variable, value, eval(variable.names)) %>% 
  mutate(value = ifelse(!is.na(value), "|", ""),
         variable = ifelse(variable == "(Intercept)", "intercept", variable)) %>%
  left_join(., order, by = "variable") %>%
  ggplot(aes(specification, reorder(variable, order), color = significant.p)) +
    geom_text(aes(label = value)) +
    scale_color_manual(values = c("black", "red")) +
    labs(x = "\nspecification number", y = "variables") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# join panels
(coef_plot = cowplot::plot_grid(top, bottom, ncol = 1, align = "v", rel_heights = c(.4, .6), labels = c('A', 'B')))
```




## uniformity
```{r}
data = model_data_snack %>%
  select_if(grepl("subjectID|fat|reward|value|cognitive|craving|balance", names(.))) %>%
  select(-c(cognitive_control_association_PEV, craving_association_PEV, reward_association_PEV, value_association_PEV)) %>%
  ungroup() %>%
  na.omit()
lm_predictors = paste(names(select(data, -c(subjectID, fat))), collapse = " + ")
lm_formula = formula(paste0("fat ~ ", lm_predictors, collapse = " + "))

full_model = lm(lm_formula,
                data = data)

clust = parallel::makeCluster(getOption("cl.cores", n_cores))
invisible(parallel::clusterCall(clust, "library", character.only = TRUE))
parallel::clusterExport(clust, "data")

fat_value_sca = MuMIn::dredge(full_model, rank = "AIC", extra = "BIC")
parallel::stopCluster(clust)

```

### extract parameter estimates, 95% CIs, and p-values
```{r}
# extract parameter estimate
model_params = MuMIn::get.models(fat_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest() %>%
  select(model_num, term, estimate) %>%
  spread(term, estimate)

# calculate 95% CIs
model_conf = MuMIn::get.models(fat_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::confint_tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest()

# extract p-values for the intercept term
model_ps_PEV = MuMIn::get.models(fat_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest() %>%
  bind_cols(., model_conf) %>%
  filter(term == "value_uniformity_PEV") %>%
  ungroup() %>%
  select(model_num, estimate, std.error, p.value, conf.low, conf.high) %>%
  arrange(p.value)

# extract p-values for the intercept term
model_ps_PE = MuMIn::get.models(fat_value_sca, subset = TRUE) %>%
  tibble() %>%
  rename("model" = ".") %>%
  mutate(tidied = purrr::map(model, broom::tidy),
         model_num = row_number()) %>%
  select(model_num, tidied) %>%
  unnest() %>%
  bind_cols(., model_conf) %>%
  filter(term == "value_PE") %>%
  ungroup() %>%
  select(model_num, estimate, std.error, p.value, conf.low, conf.high) %>%
  arrange(p.value)
```

### value ROI SCA
Value-% fat associations p < .05 are in red, p > .05 are in black

```{r, fig.width=10, fig.height=10}
null = fat_value_sca %>%
  arrange(df) %>%
  filter(df == 3 & !is.na(value_PE))

# merge and tidy for plotting
plot.data = left_join(model_ps_PE, model_params, by = c("model_num")) %>%
  select(-c(`(Intercept)`, value_PE)) %>%
  arrange(estimate) %>%
  mutate(specification = row_number(),
         significant.p = ifelse(p.value < .05, "yes", "no")) %>%
  gather(variable, val, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p,  -contains("conf")) %>% 
  mutate(`univariate ROI` = ifelse(grepl("PE", variable) & !is.na(val), 1, NA),
         `multivariate PEV` = ifelse(grepl("PEV", variable) & !is.na(val), 1, NA),
         `cognitive control` = ifelse(grepl("cognitive_control", variable) & !is.na(val), 1, NA),
         reward = ifelse(grepl("reward", variable) & !is.na(val), 1, NA),
         `value ROI only` = ifelse(estimate == null$value_PE, 1, NA),
         variable = gsub("_", " ", variable),
         variable = gsub("PE$", " ROI", variable),
         variable = gsub("PEV", " PEV", variable),
         variable = gsub("regulation association", "regulation", variable)) %>%
  spread(variable, val) %>%
  unique()

# get names of variables included in model
variable.names = names(select(plot.data, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p, -contains("conf")))

# plot top panel
top = plot.data %>%
  ggplot(aes(specification, estimate, color = significant.p)) +
    #geom_point(shape = "|", size = 4) +
    geom_pointrange(aes(ymin = conf.low, ymax = conf.high), size = .25) +
    scale_color_manual(values = c("black", "red")) + #"black", 
    #scale_y_continuous(limits = c(-1, 7), breaks = seq(-1, 7, by = 1)) +
    labs(x = "", y = "\nassociation between % fat &\nunivariate ROI") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# set plotting order for variables based on number of times it's included in better fitting models
order = plot.data %>%
  arrange(estimate) %>%
  mutate(significant.p.num = ifelse(significant.p == "yes", 1, 0)) %>%
  gather(variable, val, eval(variable.names)) %>% 
  filter(!is.na(val)) %>%
  group_by(variable) %>%
  mutate(order = sum(significant.p.num)) %>%
  select(variable, order) %>%
  unique()

# rename variables and plot bottom panel
bottom = plot.data %>%
  gather(variable, value, eval(variable.names)) %>% 
  mutate(value = ifelse(!is.na(value), "|", ""),
         variable = ifelse(variable == "(Intercept)", "intercept", variable)) %>%
  left_join(., order, by = "variable") %>%
  ggplot(aes(specification, reorder(variable, order), color = significant.p)) +
    geom_text(aes(label = value)) +
    scale_color_manual(values = c("black", "red")) + #"black", 
    labs(x = "\nspecification number", y = "variables") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# join panels
(coef_plot = cowplot::plot_grid(top, bottom, ncol = 1, align = "v", rel_heights = c(.4, .6), labels = c('A', 'B')))
```

### value PEV SCA
```{r, fig.width=10, fig.height=10}
null = fat_value_sca %>%
  arrange(df) %>%
  filter(df == 3 & !is.na(value_uniformity_PEV))

# merge and tidy for plotting
plot.data = left_join(model_ps_PEV, model_params, by = c("model_num")) %>%
  select(-c(`(Intercept)`, value_uniformity_PEV)) %>%
  arrange(estimate) %>%
  mutate(specification = row_number(),
         significant.p = ifelse(p.value < .05, "yes", "no")) %>%
  gather(variable, val, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p,  -contains("conf")) %>% 
  mutate(`univariate ROI` = ifelse(grepl("PE", variable) & !is.na(val), 1, NA),
         `multivariate PEV` = ifelse(grepl("PEV", variable) & !is.na(val), 1, NA),
         `cognitive control` = ifelse(grepl("cognitive_control", variable) & !is.na(val), 1, NA),
         reward = ifelse(grepl("reward", variable) & !is.na(val), 1, NA),
         `value PEV only` = ifelse(estimate == null$value_uniformity_PEV, 1, NA),
         variable = gsub("_", " ", variable),
         variable = gsub("PE$", " ROI", variable),
         variable = gsub("PEV", " PEV", variable),
         variable = gsub("regulation association", "regulation", variable)) %>%
  spread(variable, val) %>%
  unique()

# get names of variables included in model
variable.names = names(select(plot.data, -estimate, -specification, -model_num, -std.error, -p.value, -significant.p, -contains("conf")))

# plot top panel
top = plot.data %>%
  ggplot(aes(specification, estimate, color = significant.p)) +
    #geom_point(shape = "|", size = 4) +
    geom_pointrange(aes(ymin = conf.low, ymax = conf.high), size = .25) +
    scale_color_manual(values = c("black", "red")) +
    #scale_y_continuous(limits = c(-1, 7), breaks = seq(-1, 7, by = 1)) +
    labs(x = "", y = "\nassociation between % fat &\nmultivariate value PEV") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# set plotting order for variables based on number of times it's included in better fitting models
order = plot.data %>%
  arrange(estimate) %>%
  mutate(significant.p.num = ifelse(significant.p == "yes", 1, 0)) %>%
  gather(variable, val, eval(variable.names)) %>% 
  filter(!is.na(val)) %>%
  group_by(variable) %>%
  mutate(order = sum(significant.p.num)) %>%
  select(variable, order) %>%
  unique()

# rename variables and plot bottom panel
bottom = plot.data %>%
  gather(variable, value, eval(variable.names)) %>% 
  mutate(value = ifelse(!is.na(value), "|", ""),
         variable = ifelse(variable == "(Intercept)", "intercept", variable)) %>%
  left_join(., order, by = "variable") %>%
  ggplot(aes(specification, reorder(variable, order), color = significant.p)) +
    geom_text(aes(label = value)) +
    scale_color_manual(values = c("black", "red")) +
    labs(x = "\nspecification number", y = "variables") + 
    theme_minimal(base_size = 10) +
    theme(legend.position = "none")

# join panels
(coef_plot = cowplot::plot_grid(top, bottom, ncol = 1, align = "v", rel_heights = c(.4, .6), labels = c('A', 'B')))
```


